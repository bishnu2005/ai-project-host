; =======================
; Supervisor (container-friendly)
; =======================
[supervisord]
nodaemon=true
logfile=/dev/null
logfile_maxbytes=0
; Make sure PORT is available even if not injected by the runtime
environment=PORT="8000",PYTHONUNBUFFERED="1"

; Helpful defaults you can apply to every program with less repetition
; (Supervisor has no inheritance, so we repeat critical lines in each program)

; ---------- INTERNAL SERVICES (loopback only) ----------
[program:vad]
directory=/app/services/vad
command=uvicorn app:app --host 127.0.0.1 --port 8001 --proxy-headers
autostart=true
autorestart=true
startretries=10
startsecs=3
stopasgroup=true
killasgroup=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=10

[program:diarization]
directory=/app/services/diarization
command=uvicorn app:app --host 127.0.0.1 --port 8002 --proxy-headers
autostart=true
autorestart=true
startretries=10
startsecs=3
stopasgroup=true
killasgroup=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=10

[program:stt]
directory=/app/services/stt
command=uvicorn app:app --host 127.0.0.1 --port 8003 --proxy-headers
environment=STT_MODEL_SIZE="small"
autostart=true
autorestart=true
startretries=10
startsecs=3
stopasgroup=true
killasgroup=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=10

[program:emotion]
directory=/app/services/emotion
command=uvicorn app:app --host 127.0.0.1 --port 8004 --proxy-headers
autostart=true
autorestart=true
startretries=10
startsecs=3
stopasgroup=true
killasgroup=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=10

[program:text_sentiment]
directory=/app/services/text_sentiment
command=uvicorn app:app --host 127.0.0.1 --port 8005 --proxy-headers
autostart=true
autorestart=true
startretries=10
startsecs=3
stopasgroup=true
killasgroup=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=10

[program:fusion]
directory=/app/services/fusion
command=uvicorn app:app --host 127.0.0.1 --port 8006 --proxy-headers
autostart=true
autorestart=true
startretries=10
startsecs=3
stopasgroup=true
killasgroup=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=10

[program:llm]
directory=/app/services/llm
command=uvicorn app:app --host 127.0.0.1 --port 8007 --proxy-headers
autostart=true
autorestart=true
startretries=10
startsecs=5
stopasgroup=true
killasgroup=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
priority=10

; ---------- PUBLIC ENTRY (listen on $PORT) ----------
[program:orchestrator]
directory=/app/services/orchestrator
; If your file/module isn't app.py exposing "app", change "app:app" accordingly.
command=/bin/sh -c 'uvicorn app:app --host 0.0.0.0 --port ${PORT} --proxy-headers --forwarded-allow-ips="*"'
autostart=true
autorestart=true
; Give dependencies time to boot before we declare success
startretries=10
startsecs=8
stopasgroup=true
killasgroup=true
; If you prefer a graceful stop for uvicorn workers
stopsignal=QUIT
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
; Start after internals
priority=100

; ---------- OPTIONAL: group to manage all services together ----------
[group:stack]
programs=vad,diarization,stt,emotion,text_sentiment,fusion,llm,orchestrator
priority=1
